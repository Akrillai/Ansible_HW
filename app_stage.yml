---

- hosts: 18.132.17.140
  become: true
  # become_method: sudo
  # remote_user: root

  tasks:
  - name: Install maven 
    apt:
      name: maven
      state: present
      update_cache: true

  - name: Install Git 
    apt:
      name: git
      state: present
      update_cache: true

  - name: Git clone and cd
    shell: cd /tmp && git clone https://github.com/boxfuse/boxfuse-sample-java-war-hello.git
    ignore_errors: True


  - name: Git Clone boxfuse
    git:
      repo: https://github.com/boxfuse/boxfuse-sample-java-war-hello.git
      dest: /tmp
      clone: true
      update: true
    register: git_status

  - name: Maven when cloned ok
    shell:
      chdir: /tmp/boxfuse-sample-java-war-hello
      cmd: mvn package
    when: git_status.changed
    register: build_status

  - name: fetch war
    ansible.builtin.fetch:
      src: /tmp/boxfuse-sample-java-war-hello/target/hello-1.0.war
      dest: /tmp/
      flat: true
      register: fetch_status


- hosts: 13.41.240.138 
  become: yes
  # become_method: sudo
  # remote_user: root

  tasks:

  # - name: Copy a "sudoers" file on the remote machine for editing
  #   copy:
  #     src: /tmp/hello-1.0.war
  #     dest: /usr/local

  - name: Install OpenJDK
    apt:
      name: openjdk-11-jre-headless
      state: present
      update_cache: true

  - name: download tomcat server packages
    get_url:
      url: https://archive.apache.org/dist/tomcat/tomcat-9/v9.0.44/bin/apache-tomcat-9.0.44.tar.gz
      dest: /usr/local

  - name: extract tomcat packages
    unarchive:
      src: /usr/local/apache-tomcat-9.0.44.tar.gz
      dest: /usr/local
      remote_src: yes

  - name: add fusebox war
    ansible.builtin.copy:
      src: /tmp/hello-1.0.war
      dest: /usr/local/apache-tomcat-9.0.44/webapps

  - name: start tomcat services
    shell: nohup /usr/local/apache-tomcat-9.0.44/bin/startup.sh

  - name: start tomcat services
    shell:
      chdir: /usr/local/apache-tomcat-9.0.44/bin/startup.sh
      cmd: nohup
